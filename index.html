<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sand Dissolve Slideshow</title>

  <!-- Manrope ExtraLight -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color:#0b0c10;

      /* Slideshow timings */
      --slide-duration: 6s;
      --transition-duration: 1.6s;

      /* Widget sizing + independent margins (visual px) */
      --ui-scale: 2.0;      /* overall widget scale */
      --top-gap:  24px;     /* distance from top-left wrapper to edges */
      --left-gap: 24px;
      --right-gap: 24px;    /* distance from bottom-right wrapper to edges */
      --bottom-gap:24px;

      /* Card widths (unscaled logical px) */
      --widget-width: 240px;
      --news-width:   240px;
    }

    html, body {
      height:100%; margin:0; background:var(--bg-color);
      font-family:'Manrope',sans-serif; font-weight:200;
      overflow:hidden; color:#eef1f5;
    }

    .stage { position:fixed; inset:0; overflow:hidden; background:var(--bg-color); }

    /* Center the canvas; JS sets pixel size to preserve aspect (no distortion) */
    canvas{
      position:absolute;
      top:50%; left:50%;
      transform: translate(-50%, -50%);
      width:auto; height:auto;
      display:block; z-index:0;
    }

    .vignette::after{ content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(120% 120% at 50% 60%, transparent 45%, rgba(0,0,0,0.28) 100%);
      mix-blend-mode:multiply; }

    .badge{ position:absolute; right:24px; bottom:20px; color:#fff; opacity:0; font:200 14px 'Manrope',sans-serif; }
    @media (prefers-reduced-motion: reduce){ :root{ --transition-duration: 0s; } }

    /* === LEFT widgets column (Weather + AQI) === */
    .widgets-left{
      position: fixed;
      top:  calc(var(--top-gap)  / var(--ui-scale));
      left: calc(var(--left-gap) / var(--ui-scale));
      z-index:1000; pointer-events:auto;
      display:flex; flex-direction:column; gap:14px; align-items:flex-start;
      transform: scale(var(--ui-scale)) translateZ(0);
      transform-origin: top left;
      -webkit-font-smoothing: antialiased;
    }

    /* === BOTTOM-RIGHT (News) === */
    .widgets-br{
      position: fixed;
      right:  calc(var(--right-gap)  / var(--ui-scale));
      bottom: calc(var(--bottom-gap) / var(--ui-scale));
      z-index:1000; pointer-events:auto;
      display:flex; flex-direction:column; gap:12px; align-items:flex-end;
      transform: scale(var(--ui-scale)) translateZ(0);
      transform-origin: bottom right;
      -webkit-font-smoothing: antialiased;
    }

    /* Card base */
    .card{
      border-radius: 22px;
      padding: 10px;
      background: rgba(18, 20, 24, 0.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 28px rgba(0,0,0,0.25);
      font-weight: 200; color: #eef1f5;
    }

    .card-header{
      display:flex; justify-content:space-between; align-items:center;
      padding: 8px 12px;
      margin: -2px -2px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      font-size: 13px; letter-spacing:.3px;
    }

    /* ===== Weather card ===== */
    #weatherCard{ width: var(--widget-width); }
    #weatherCard .weather-row{
      display:flex; flex-direction:column; gap:6px; align-items:flex-start;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      margin-bottom: 10px;
    }
    #weatherCard .weather-icon{
      font-size: 24px; line-height:1;
      /* full-color icons (no grayscale) */
      width: 100%; text-align: center; align-self: center; margin-top: 2px;
    }
    #weatherCard .weather-temp{ font-size: 42px; line-height:1; font-weight:200; margin-top: 2px; }
    #weatherCard .weather-desc{ font-size: 13px; opacity:.92; }

    #weatherCard .weather-forecast{ display: grid; grid-template-columns: 1fr; gap: 8px; }
    #weatherCard .forecast-item{
      display:grid;
      grid-template-columns: 1fr 40px 48px;  /* time | icon | temp */
      align-items:center;
      padding: 8px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
    }
    #weatherCard .forecast-time{ font-size: 12px; opacity:.9; }
    #weatherCard .wx{
      display:flex; align-items:center; justify-content:center;
      width:40px; height:20px; margin:0 auto;
      /* full-color icons (no grayscale) */
      text-align:center;
    }
    #weatherCard .forecast-temp{
      justify-self:end;
      font-size: 13px; padding: 6px 8px; min-width: 42px; text-align:center;
      background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; opacity:.95;
    }

    /* ===== AQI card ===== */
    #aqiCard{ width: var(--widget-width); }
    #aqiCard .aqi-body{
      display:flex; flex-direction:column; gap:8px; align-items:center;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
    }
    #aqiValue{ font-size:40px; line-height:1; }
    #aqiCat{ font-size:13px; opacity:.92; }
    #aqiBadge{
      font-size:12px; padding:4px 8px; border-radius:10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      line-height:1;
    }
    .aqi-bar{
      width:100%; height:6px; border-radius:4px;
      background: linear-gradient(90deg,#2ecc71,#f1c40f,#e67e22,#e74c3c,#9b59b6,#7f1d1d);
      opacity:.75;
      position: relative; overflow:hidden;
    }
    .aqi-pointer{
      position:absolute; top:-3px; width:2px; height:12px; background:#fff; border-radius:1px; opacity:.9;
      left:0%;
    }
    .aqi-metrics{ margin-top:6px; display:flex; gap:8px; }
    .pill{
      font-size:11px; padding:6px 8px; border-radius:10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .pill strong{ font-weight:400; margin-left:6px; }

    /* ======= News (bottom-right) ======= */
    #newsCard{
      width: var(--news-width);
      border-radius: 22px;
      padding: 10px;
      background: rgba(18, 20, 24, 0.50);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 28px rgba(0,0,0,0.28);
    }
    #newsCard .card-header{ margin-bottom: 6px; }
    .news-slide{
      position: relative;
      min-height: 88px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
    }
    .news-title{
      font-size: 16px; line-height: 1.25; font-weight: 300;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      margin: 0 0 6px 0;
      color:#eef1f5; text-decoration:none;
    }
    .news-title:visited{ color:#eef1f5; }
    .news-title:hover{ text-decoration:underline; }
    .news-meta{ font-size: 12px; opacity: .85; display:flex; gap:8px; align-items:center; }
    .news-meta .dot{ width:4px; height:4px; background:#fff9; border-radius: 2px; display:inline-block; }
    .news-fade-enter{ opacity: 0; transform: translateY(6px); }
    .news-fade-leave{ opacity: 0; transform: translateY(-6px); }
    .news-fade{ transition: opacity .4s ease, transform .4s ease; }
    .news-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .news-btn{
      font-size: 12px; padding:6px 10px; border-radius: 12px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
      cursor:pointer; user-select:none;
    }
    .news-btn:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="stage vignette">
    <canvas id="glcanvas"></canvas>
    <div class="badge" id="badge"></div>

    <!-- LEFT widgets column -->
    <div class="widgets-left">

      <!-- Weather -->
      <div class="card" id="weatherCard">
        <div class="card-header">
          <span>Weather</span>
          <span id="weatherCity">‚Äî</span>
        </div>
        <div class="weather-row">
          <div class="weather-icon" id="weatherIcon" aria-hidden="true">‚òÅÔ∏è</div>
          <div class="weather-main">
            <div class="weather-temp" id="weatherTemp">--¬∞</div>
            <div class="weather-desc" id="weatherDesc">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="weather-forecast" id="weatherForecast"></div>
      </div>

      <!-- AQI -->
      <div class="card" id="aqiCard">
        <div class="card-header">
          <span>Air Quality</span>
          <span id="aqiCity">‚Äî</span>
        </div>
        <div class="aqi-body">
          <div id="aqiBadge">AQI ‚Äî</div>
          <div id="aqiValue">--</div>
          <div id="aqiCat">Loading‚Ä¶</div>
          <div class="aqi-bar"><div class="aqi-pointer" id="aqiPointer"></div></div>
          <div class="aqi-metrics">
            <div class="pill">PM2.5<strong id="pm25">‚Äî</strong></div>
            <div class="pill">PM10<strong id="pm10">‚Äî</strong></div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTTOM-RIGHT: News -->
    <div class="widgets-br">
      <div class="card" id="newsCard">
        <div class="card-header">
          <span>News</span>
          <span id="newsSource">updating‚Ä¶</span>
        </div>
        <div class="news-slide">
          <div id="newsContainer" class="news-fade">
            <a id="newsLink" href="#" target="_blank" rel="noopener noreferrer" class="news-title">Loading headlines‚Ä¶</a>
            <div class="news-meta">
              <span id="newsSourceInline">‚Äî</span>
              <span class="dot"></span>
              <span id="newsTime">‚Äî</span>
            </div>
          </div>
          <div class="news-actions">
            <div class="news-btn" id="prevNews">Prev</div>
            <div class="news-btn" id="nextNews">Next</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
  // ========= Config =========
  const CITY_NAME = "Sultanpur, Delhi, India";
  const COUNTRY_CODE = "IN";

  // Slideshow behaviour
  const ANIMATION_MODE = 'crossfade';  // 'crossfade' | 'wipe' | 'cut' | 'sand' (heavy)
  const RENDER_SCALE   = 0.75;         // 1 = full viewport res; lower to reduce GPU work

  const FALLBACK_COORDS = { latitude: 28.4959, longitude: 77.1500, label: "Sultanpur, Delhi, India" };

  // Slides (PNG supported)
  const IMAGES = [
    "images/slide1.png",
    "images/slide2.png",
    "images/slide3.png",
    "images/slide4.png",
    "images/slide5.png",
  ];

  // CSS var readers
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function readSeconds(name, fallback){ const v = cssVar(name); const n = parseFloat((v||'').replace('s','')); return isFinite(n)?n*1000:fallback*1000; }

  // Declare ONCE
  const SLIDE_MS      = readSeconds('--slide-duration', 6);
  const TRANSITION_MS = readSeconds('--transition-duration', 1.6);

  // ========= WebGL2 setup (dynamic buffer + letterboxed sizing) =========
  const canvas = document.getElementById('glcanvas');
  const gl = canvas.getContext('webgl2', { premultipliedAlpha: true, antialias: true });
  if(!gl){ alert('WebGL2 not available'); }

  function sizeGLBuffer(){
    const vw = Math.max(1, Math.floor(window.innerWidth  * RENDER_SCALE));
    const vh = Math.max(1, Math.floor(window.innerHeight * RENDER_SCALE));
    canvas.width  = vw;
    canvas.height = vh;
    gl.viewport(0, 0, canvas.width, canvas.height);
  }
  function fitCanvasToViewport(){
    canvas.style.width  = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
  }
  function resize(){ sizeGLBuffer(); fitCanvasToViewport(); }
  resize(); window.addEventListener('resize', resize);

  // ===== Shaders =====
  const vs = `#version 300 es
  precision highp float;
  const vec2 POS[4] = vec2[4](vec2(-1.,-1.), vec2(1.,-1.), vec2(-1.,1.), vec2(1.,1.));
  out vec2 vUv;
  void main(){ vec2 p = POS[gl_VertexID]; vUv = p*0.5+0.5; gl_Position = vec4(p,0.,1.); }`;

  function fsFor(mode){
    if(mode === 'crossfade'){
      return `#version 300 es
      precision highp float; in vec2 vUv; out vec4 frag;
      uniform sampler2D uTex0, uTex1; uniform vec2 uResolution; uniform float uProgress;
      vec2 coverUv(vec2 uv, vec2 ts, vec2 rs){
        float rTex=ts.x/ts.y, rCan=rs.x/rs.y;
        if(rTex>rCan){ float s=rTex/rCan; uv.y=(uv.y-.5)*s+.5; } else { float s=rCan/rTex; uv.x=(uv.x-.5)*s+.5; } return uv;
      }
      void main(){
        vec2 rs=uResolution;
        vec2 s0=vec2(textureSize(uTex0,0)), s1=vec2(textureSize(uTex1,0));
        vec4 c0=texture(uTex0, coverUv(vUv,s0,rs));
        vec4 c1=texture(uTex1, coverUv(vUv,s1,rs));
        frag = mix(c0,c1, clamp(uProgress,0.,1.));
      }`;
    }
    if(mode === 'wipe'){
      return `#version 300 es
      precision highp float; in vec2 vUv; out vec4 frag;
      uniform sampler2D uTex0, uTex1; uniform vec2 uResolution; uniform float uProgress;
      vec2 coverUv(vec2 uv, vec2 ts, vec2 rs){
        float rTex=ts.x/ts.y, rCan=rs.x/rs.y;
        if(rTex>rCan){ float s=rTex/rCan; uv.y=(uv.y-.5)*s+.5; } else { float s=rCan/rTex; uv.x=(uv.x-.5)*s+.5; } return uv;
      }
      void main(){
        vec2 rs=uResolution;
        vec2 s0=vec2(textureSize(uTex0,0)), s1=vec2(textureSize(uTex1,0));
        vec4 c0=texture(uTex0, coverUv(vUv,s0,rs));
        vec4 c1=texture(uTex1, coverUv(vUv,s1,rs));
        float edge = 0.01;
        float m = smoothstep(uProgress-edge, uProgress+edge, vUv.x);
        frag = mix(c0,c1,m);
      }`;
    }
    if(mode === 'cut'){
      return `#version 300 es
      precision highp float; in vec2 vUv; out vec4 frag;
      uniform sampler2D uTex0, uTex1; uniform vec2 uResolution; uniform float uProgress;
      vec2 coverUv(vec2 uv, vec2 ts, vec2 rs){
        float rTex=ts.x/ts.y, rCan=rs.x/rs.y;
        if(rTex>rCan){ float s=rTex/rCan; uv.y=(uv.y-.5)*s+.5; } else { float s=rCan/rTex; uv.x=(uv.x-.5)*s+.5; } return uv;
      }
      void main(){
        vec2 rs=uResolution;
        vec2 s0=vec2(textureSize(uTex0,0)), s1=vec2(textureSize(uTex1,0));
        vec4 c0=texture(uTex0, coverUv(vUv,s0,rs));
        vec4 c1=texture(uTex1, coverUv(vUv,s1,rs));
        frag = (uProgress<0.999) ? c0 : c1;
      }`;
    }
    /* heavy 'sand' fallback (avoid on weak GPU) */
    return `#version 300 es
    precision highp float; in vec2 vUv; out vec4 frag;
    uniform sampler2D uTex0, uTex1; uniform vec2 uResolution;
    uniform float uProgress, uTime;
    float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7)))*43758.5453123); }
    float noise(vec2 p){ vec2 i=floor(p), f=fract(p); float a=hash(i), b=hash(i+vec2(1,0)), c=hash(i+vec2(0,1)), d=hash(i+vec2(1,1)); vec2 u=f*f*(3.-2.*f); return mix(mix(a,b,u.x), mix(c,d,u.x), u.y); }
    float fbm(vec2 p){ float v=0., a=.5; mat2 m=mat2(1.6,1.2,-1.2,1.6); for(int i=0;i<5;i++){ v+=a*noise(p); p=m*p; a*=.5; } return v; }
    vec2 coverUv(vec2 uv, vec2 ts, vec2 rs){ float rTex=ts.x/ts.y, rCan=rs.x/rs.y;
      if(rTex>rCan){ float s=rTex/rCan; uv.y=(uv.y-.5)*s+.5; } else { float s=rCan/rTex; uv.x=(uv.x-.5)*s+.5; } return uv; }
    void main(){
      vec2 rs=uResolution; float n=fbm(vUv*rs/400. + vec2(uTime*.05, uTime*.03));
      float edge=.18; float mask=(uProgress<=0.)?0.:1.-smoothstep(uProgress-edge,uProgress+edge,n);
      vec2 s0=vec2(textureSize(uTex0,0)), s1=vec2(textureSize(uTex1,0));
      vec4 c0=texture(uTex0, coverUv(vUv,s0,rs));
      vec4 c1=texture(uTex1, coverUv(vUv,s1,rs));
      frag=mix(c0,c1,mask);
    }`;
  }

  function compile(type, src){
    const s=gl.createShader(type);
    gl.shaderSource(s,src); gl.compileShader(s);
    if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s));
    return s;
  }
  function program(vsSrc, fsSrc){
    const p=gl.createProgram();
    gl.attachShader(p, compile(gl.VERTEX_SHADER,vsSrc));
    gl.attachShader(p, compile(gl.FRAGMENT_SHADER,fsSrc));
    gl.linkProgram(p);
    if(!gl.getProgramParameter(p, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(p));
    return p;
  }

  const prog = program(vs, fsFor(ANIMATION_MODE));
  gl.useProgram(prog);
  const loc = {
    uTex0: gl.getUniformLocation(prog, 'uTex0'),
    uTex1: gl.getUniformLocation(prog, 'uTex1'),
    uResolution: gl.getUniformLocation(prog, 'uResolution'),
    uProgress: gl.getUniformLocation(prog, 'uProgress'),
    uTime: gl.getUniformLocation(prog, 'uTime'), // only used by 'sand'
  };
  const vao = gl.createVertexArray(); gl.bindVertexArray(vao);

  // Textures
  function createTexture(img){ const tex = gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D, tex);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
    gl.pixelStorei(gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, gl.NONE);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
    return tex; }
  function createBlankTexture(){
    const tex = gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D, tex);
    const pixel = new Uint8Array([0,0,0,255]);
    gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,pixel);
    return tex;
  }
  async function loadImage(src){ return new Promise((res, rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }

  let images=[], textures=[];
  (async()=>{
    try{
      images = await Promise.all(IMAGES.map(loadImage));
      textures = images.map(createTexture);
    }catch(e){
      console.warn('Image load failed, using blank texture', e);
      textures = [createBlankTexture(), createBlankTexture()];
    } finally {
      start();                 // ALWAYS start widgets + render loop
    }
  })();

  // Slideshow engine
  let currentIndex = 0, nextIndex = 1;
  let phase = 'dwell', phaseEnd = performance.now();
  let widgetsStarted = false;

  function bindTextures(i0, i1){
    gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, textures[i0 % textures.length]); gl.uniform1i(loc.uTex0, 0);
    gl.activeTexture(gl.TEXTURE1); gl.bindTexture(gl.TEXTURE_2D, textures[i1 % textures.length]); gl.uniform1i(loc.uTex1, 1);
  }

  function start(){
    if(!widgetsStarted){ widgetsStarted = true; initWeatherAndAQI(); initNews(); } // ensure widgets even if images failed
    if(textures.length < 2) textures.push(textures[0]); // safe pair

    bindTextures(currentIndex, nextIndex);
    phase = 'dwell'; phaseEnd = performance.now() + SLIDE_MS;
    gl.uniform1f(loc.uProgress, 0.0);
    requestAnimationFrame(loop);
  }

  function loop(now){
    const res = [canvas.width, canvas.height];
    gl.uniform2f(loc.uResolution, res[0], res[1]);
    if (loc.uTime) gl.uniform1f(loc.uTime, now*0.001); // used by 'sand'

    if(now >= phaseEnd){
      if(phase === 'dwell'){ phase='transition'; phaseEnd=now+TRANSITION_MS; bindTextures(currentIndex,nextIndex); }
      else{ currentIndex=nextIndex; nextIndex=(currentIndex+1)%textures.length; bindTextures(currentIndex,nextIndex); phase='dwell'; phaseEnd=now+SLIDE_MS; gl.uniform1f(loc.uProgress,0.0); }
    }

    if(phase === 'transition'){
      const dur = Math.max(1.0, TRANSITION_MS);
      const t = 1.0 - Math.max(0.0, (phaseEnd - now) / dur);
      const eased = 1.0 - Math.pow(1.0 - t, 3.0);
      gl.uniform1f(loc.uProgress, eased);
    } else {
      gl.uniform1f(loc.uProgress, 0.0);
    }

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
    requestAnimationFrame(loop);
  }

  // ===== Weather + AQI =====
  async function resolveLocation(q, countryCode=""){
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=10&language=en&format=json`;
    const geo = await fetch(url, {cache:'no-cache'}).then(r=>r.json());
    if (geo && geo.results && geo.results.length){
      const byDelhi = geo.results.find(r => /delhi/i.test(r.admin1 || ""));
      const byIN    = geo.results.find(r => (r.country_code || "").toUpperCase() === (countryCode || "IN").toUpperCase());
      const pick    = byDelhi || byIN || geo.results[0];
      return { latitude: pick.latitude, longitude: pick.longitude, label: [pick.name, pick.country].filter(Boolean).join(', ') };
    }
    throw new Error("No geocoding match");
  }

  async function initWeatherAndAQI(){
    try{
      const place = await resolveLocation(CITY_NAME, COUNTRY_CODE);
      document.getElementById('weatherCity').textContent = place.label;
      document.getElementById('aqiCity').textContent     = place.label;

      const wurl = `https://api.open-meteo.com/v1/forecast?latitude=${place.latitude}&longitude=${place.longitude}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&timezone=auto`;
      const wdata = await fetch(wurl, {cache:'no-cache'}).then(r=>r.json());
      renderWeather(wdata);

      await fetchAQI(place.latitude, place.longitude);
    }catch(err){
      document.getElementById('weatherCity').textContent = FALLBACK_COORDS.label;
      document.getElementById('aqiCity').textContent     = FALLBACK_COORDS.label;
      try{
        const wurl = `https://api.open-meteo.com/v1/forecast?latitude=${FALLBACK_COORDS.latitude}&longitude=${FALLBACK_COORDS.longitude}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&timezone=auto`;
        const wdata = await fetch(wurl, {cache:'no-cache'}).then(r=>r.json());
        renderWeather(wdata);
        await fetchAQI(FALLBACK_COORDS.latitude, FALLBACK_COORDS.longitude);
      }catch(e){
        document.getElementById('weatherDesc').textContent = 'Weather unavailable';
      }
    }
  }

  function wxIcon(code){
    if(code===0) return '‚òÄÔ∏è';
    if([1,2].includes(code)) return 'üå§Ô∏è';
    if(code===3) return '‚òÅÔ∏è';
    if([45,48].includes(code)) return 'üå´Ô∏è';
    if([51,53,55,56,57].includes(code)) return 'üå¶Ô∏è';
    if([61,63,65].includes(code)) return 'üåßÔ∏è';
    if([66,67,71,73,75,77].includes(code)) return 'üå®Ô∏è';
    if([80,81,82].includes(code)) return 'üåßÔ∏è';
    if([95,96,99].includes(code)) return '‚õàÔ∏è';
    return '‚òÅÔ∏è';
  }
  function wxText(code){
    const map = {0:'Clear',1:'Mostly clear',2:'Partly cloudy',3:'Cloudy',45:'Fog',48:'Rime fog',51:'Drizzle',53:'Drizzle',55:'Drizzle',56:'Freezing drizzle',57:'Freezing drizzle',61:'Rain',63:'Rain',65:'Heavy rain',66:'Freezing rain',67:'Freezing rain',71:'Snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Showers',81:'Showers',82:'Heavy showers',95:'Thunderstorm',96:'Thunderstorm',99:'Thunderstorm'};
    return map[code] || '‚Äî';
  }
  function renderWeather(data){
    const cur = data.current;
    document.getElementById('weatherTemp').textContent = Math.round(cur.temperature_2m) + '¬∞';
    document.getElementById('weatherDesc').textContent = wxText(cur.weather_code);
    document.getElementById('weatherIcon').textContent = wxIcon(cur.weather_code);

    const fcEl = document.getElementById('weatherForecast');
    fcEl.innerHTML = '';
    const nowIdx = data.hourly.time.findIndex(t=> new Date(t).getTime() >= Date.now());
    for(let i=0;i<3;i++){
      const idx = Math.min(nowIdx + i, data.hourly.time.length-1);
      const t = new Date(data.hourly.time[idx]);
      const temp = Math.round(data.hourly.temperature_2m[idx]);
      const w = data.hourly.weather_code[idx];
      const div = document.createElement('div');
      div.className='forecast-item';
      div.innerHTML = `
        <span class="forecast-time">${String(t.getHours()).padStart(2,'0')}:00</span>
        <span class="wx">${wxIcon(w)}</span>
        <span class="forecast-temp">${temp}¬∞</span>`;
      fcEl.appendChild(div);
    }
  }

  // ===== AQI =====
  function aqiInfo(aqi){
    if (aqi == null || !isFinite(aqi)) return {label:'‚Äî', color:'rgba(255,255,255,0.12)', pos:0};
    if (aqi <= 50)   return {label:'Good',                  color:'#2ecc71', pos: (aqi/500)*100};
    if (aqi <= 100)  return {label:'Moderate',              color:'#f1c40f', pos: (aqi/500)*100};
    if (aqi <= 150)  return {label:'Unhealthy (Sensitive)', color:'#e67e22', pos: (aqi/500)*100};
    if (aqi <= 200)  return {label:'Unhealthy',             color:'#e74c3c', pos: (aqi/500)*100};
    if (aqi <= 300)  return {label:'Very Unhealthy',        color:'#9b59b6', pos: (aqi/500)*100};
    return            {label:'Hazardous',                   color:'#7f1d1d', pos: Math.min(100,(aqi/500)*100)};
  }

  async function fetchAQI(lat, lon){
    try{
      const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,pm10`;
      const data = await fetch(url, {cache:'no-cache'}).then(r=>r.json());
      const aqi  = data?.current?.us_aqi;
      const pm25 = data?.current?.pm2_5;
      const pm10 = data?.current?.pm10;

      const info = aqiInfo(aqi);
      document.getElementById('aqiBadge').style.borderColor = info.color;
      document.getElementById('aqiBadge').style.boxShadow   = `inset 0 0 0 1px ${info.color}22`;
      document.getElementById('aqiBadge').textContent       = `AQI ${Math.round(aqi)}`;
      document.getElementById('aqiValue').textContent       = Math.round(aqi);
      document.getElementById('aqiCat').textContent         = info.label;
      document.getElementById('aqiPointer').style.left      = `${info.pos}%`;
      document.getElementById('pm25').textContent           = (pm25!=null)? `${Math.round(pm25)} ¬µg/m¬≥` : '‚Äî';
      document.getElementById('pm10').textContent           = (pm10!=null)? `${Math.round(pm10)} ¬µg/m¬≥` : '‚Äî';
    }catch(e){
      document.getElementById('aqiBadge').textContent = 'AQI ‚Äî';
      document.getElementById('aqiCat').textContent   = 'Unavailable';
    }
  }

  // ===== News (HackerNews + Reddit). AUTO ROTATE every 10s. Robust even if sources fail. =====
  const NEWS_ROTATE_MS = 10000;

  function prettyTime(ds){
    if(!ds) return "just now";
    const d = new Date(ds);
    if (isNaN(d)) return "‚Äî";
    const diff = (Date.now() - d.getTime())/1000;
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff/60) + "m ago";
    if (diff < 86400) return Math.floor(diff/3600) + "h ago";
    return d.toLocaleDateString();
  }

  async function fetchHN(count=25){
    const ids = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json',{cache:'no-cache'}).then(r=>r.json());
    const head = (ids||[]).slice(0, count);
    const items = await Promise.all(head.map(id =>
      fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`,{cache:'no-cache'})
        .then(r=>r.json()).catch(()=>null)
    ));
    return items.filter(Boolean).map(it=>({
      title: it.title,
      link: it.url || `https://news.ycombinator.com/item?id=${it.id}`,
      date: it.time ? new Date(it.time*1000).toISOString() : '',
      source: 'Hacker News'
    }));
  }

  async function fetchReddit(count=20){
    const json = await fetch(`https://www.reddit.com/r/worldnews/top.json?limit=${count}&t=day`,{cache:'no-cache'})
      .then(r=>r.json());
    return (json.data?.children||[]).map(({data})=>({
      title: data.title,
      link: data.url_overridden_by_dest || ('https://www.reddit.com' + data.permalink),
      date: data.created_utc ? new Date(data.created_utc*1000).toISOString() : '',
      source: 'r/worldnews'
    }));
  }

  let newsList = []; let newsIndex = 0; let newsTimer;

  function setNewsSlide(item){
    const link = document.getElementById('newsLink');
    const src  = document.getElementById('newsSourceInline');
    const tim  = document.getElementById('newsTime');
    const hdr  = document.getElementById('newsSource');

    link.textContent = item.title || '‚Äî';
    link.href = item.link || '#';
    src.textContent  = item.source || '‚Äî';
    hdr.textContent  = item.source || 'News';
    tim.textContent  = prettyTime(item.date);
  }

  function renderNews(){
    const cont = document.getElementById('newsContainer');
    cont.classList.add('news-fade-leave');
    setTimeout(()=>{
      setNewsSlide(newsList[newsIndex]);
      cont.classList.remove('news-fade-leave');
      cont.classList.add('news-fade-enter');
      setTimeout(()=>cont.classList.remove('news-fade-enter'), 140);
    }, 140);
  }

  function stepNews(dir){
    if (!newsList.length) return;
    newsIndex = (newsIndex + dir + newsList.length) % newsList.length;
    renderNews();
  }

  async function initNews(){
    // show immediate placeholder (already in DOM)
    let all = [];
    try { all = all.concat(await fetchHN(25)); } catch(e){ console.warn('HN failed', e); }
    try { all = all.concat(await fetchReddit(20)); } catch(e){ console.warn('Reddit failed', e); }

    if(!all.length){
      all = [{ title:'No news feeds reachable right now.', link:'#', date:new Date().toISOString(), source:'Local' }];
    }

    all.sort((a,b)=> new Date(b.date) - new Date(a.date));
    newsList = all.slice(0, 60);
    newsIndex = 0;
    renderNews();

    document.getElementById('prevNews').onclick = ()=> stepNews(-1);
    document.getElementById('nextNews').onclick = ()=> stepNews(+1);

    clearInterval(newsTimer);
    newsTimer = setInterval(()=> stepNews(+1), NEWS_ROTATE_MS);
  }
  // =======================================

  </script>
</body>
</html>
